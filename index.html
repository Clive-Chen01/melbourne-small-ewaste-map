<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Melbourne Small Eâ€‘waste Map</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .legend {
    background: white; padding: 8px 10px; border-radius: 4px; line-height: 1.4;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<script>
// Data extracted from your KMZ
const DATA = {"markers": [{"name": "66 Errol St", "desc": "", "lat": -37.803596, "lng": 144.949765}, {"name": "Boyd Community Hub", "desc": "", "lat": -37.8256331, "lng": 144.9610465}, {"name": "437 Dynon Rd", "desc": "", "lat": -37.8026902, "lng": 144.9138836}, {"name": "22 George St", "desc": "", "lat": -37.815562, "lng": 144.989604}, {"name": "251 Faraday St", "desc": "", "lat": -37.798717, "lng": 144.9653568}, {"name": "30-34 Bellair St", "desc": "", "lat": -37.7894484, "lng": 144.9286227}, {"name": "107 Victoria Harbour Promenade", "desc": "", "lat": -37.8200128, "lng": 144.9404861}, {"name": "Officeworks", "desc": "", "lat": -37.8154826, "lng": 144.9602371}, {"name": "Officeworks", "desc": "", "lat": -37.8156818, "lng": 144.9635464}, {"name": "Officeworks", "desc": "", "lat": -37.810632, "lng": 144.9656403}, {"name": "ALDI", "desc": "", "lat": -37.8067053, "lng": 144.9615586}, {"name": "ALDI", "desc": "", "lat": -37.8301127, "lng": 144.9569134}], "polylines": [], "polygons": [], "centre": {"lat": -37.81118949166666, "lng": 144.95472170833332}};

const map = L.map('map').setView([DATA.centre.lat, DATA.centre.lng], 13);
L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap &copy; Carto'
}).addTo(map);


// Helper to build Google Maps directions URL
function navUrl(lat, lng) {
  let origin = 'Current+Location';
  if (window.__userLoc && typeof window.__userLoc.lat === 'number') {
    origin = `${window.__userLoc.lat},${window.__userLoc.lng}`;
  }
  return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${lat},${lng}`;
}
// Marker icons
const greenIcon = L.icon({
  iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
});

// Add markers
const markerGroup = L.layerGroup().addTo(map);
DATA.markers.forEach(m => {
  // Build popup using DOM to avoid any in-app browser sanitisation quirks
  const container = document.createElement('div');
  const title = document.createElement('b');
  title.textContent = m.name;
  container.appendChild(title);
  if (m.desc) {
    const br1 = document.createElement('br');
    container.appendChild(br1);
    const desc = document.createElement('span');
    desc.innerHTML = m.desc; // keep original formatting from KML
    container.appendChild(desc);
  }
  const br2 = document.createElement('br');
  container.appendChild(br2);
  const link = document.createElement('a');
  link.textContent = 'Click here to navigate';
  link.href = navUrl(m.lat, m.lng);
  // Do NOT use target=_blank to avoid in-app browser blocking; allow same-tab open
  link.rel = 'noopener';
  link.style.textDecoration = 'underline';
  link.style.fontWeight = '600';
  container.appendChild(link);

  L.marker([m.lat, m.lng], { icon: greenIcon }).bindPopup(container).addTo(markerGroup);
});

// Add polylines (if any)
DATA.polylines.forEach(pl => {
  L.polyline(pl.coords, { weight: 3 }).bindPopup(`<b>${pl.name}</b>`).addTo(map);
});

// Add polygons (if any)
DATA.polygons.forEach(pg => {
  L.polygon(pg.rings, { weight: 2, fillOpacity: 0.1 }).bindPopup(`<b>${pg.name}</b>`).addTo(map);
});

// Fit bounds if we have multiple features
const bounds = L.latLngBounds([]);
markerGroup.eachLayer(layer => bounds.extend(layer.getLatLng()));
DATA.polylines.forEach(pl => bounds.extend(L.latLngBounds(pl.coords)));
DATA.polygons.forEach(pg => pg.rings.forEach(r => bounds.extend(L.latLngBounds(r))));
if (bounds.isValid()) {
  map.fitBounds(bounds.pad(0.1));
}

// ---- Geolocate user and auto-zoom to nearby points ----
function haversine(lat1, lon1, lat2, lon2) {
  const toRad = d => d * Math.PI / 180;
  const R = 6371000; // metres
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function focusNearby(userLatLng) {
  const distances = [];
  markerGroup.eachLayer(layer => {
    const ll = layer.getLatLng();
    const d = haversine(userLatLng.lat, userLatLng.lng, ll.lat, ll.lng);
    distances.push({layer, d});
  });
  distances.sort((a,b) => a.d - b.d);

  const NEAR_RADIUS = 2000; // 2km
  const near = distances.filter(x => x.d <= NEAR_RADIUS);
  const chosen = (near.length > 0 ? near : distances.slice(0, 3));

  const fit = L.latLngBounds([userLatLng]);
  chosen.forEach(x => fit.extend(x.layer.getLatLng()));
  if (fit.isValid()) map.fitBounds(fit.pad(0.25));
}

const locateControl = L.control({position: 'topleft'});
locateControl.onAdd = function() {
  const btn = L.DomUtil.create('button', 'leaflet-bar');
  btn.title = 'Locate me';
  btn.innerHTML = 'ðŸ“';
  btn.style.cursor = 'pointer';
  btn.style.fontSize = '18px';
  btn.style.width = '34px';
  btn.style.height = '34px';
  btn.style.lineHeight = '30px';
  btn.style.textAlign = 'center';
  L.DomEvent.on(btn, 'click', (e)=>{
    e.preventDefault();
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true, timeout: 8000 });
    }
  });
  return btn;
};
locateControl.addTo(map);

function success(pos) {
  window.__userLoc = { lat: latitude, lng: longitude }; // store for navigation links
  const { latitude, longitude } = pos.coords;
  const user = L.latLng(latitude, longitude);
  L.circleMarker(user, { radius: 7 }).addTo(map).bindPopup('You are here').openPopup();
  focusNearby({lat: latitude, lng: longitude});
}
function error(err) {
  console.warn('Geolocation error', err);
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true, timeout: 8000 });
}

</script>
</body>
</html>
